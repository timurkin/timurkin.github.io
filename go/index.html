<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>NICE GIRLS)))0))</title>
    <link rel="stylesheet" href="http://peretz74.ru/assets/css/bootstrap.css"/>
    <style>
        @media (min-width: 1px) and (max-width: 767px) {
            #items-content[data-columns]::before {
                content: '1 .col-xs-12';
            }
        }

        @media (min-width: 768px) and (max-width: 991px) {
            #items-content[data-columns]::before {
                content: '2 .col-sm-6';
            }
        }

        @media (min-width: 992px) and (max-width: 9999px) {
            #items-content[data-columns]::before {
                content: '3 .col-md-4';
            }
        }

    </style>
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>

</head>
<body>
<div class="container">
    <br><br><br>
    <div class="auth">
        <div id="login_button" onclick="VK.Auth.login(authInfo, 4);"></div>
    </div>
    <div id="items-content" class="row" data-columns>
        <div></div>
    </div>
</div>
</body>
<script type="text/javascript">
    var people = [];
    var curr_id =0;
    var uPhotos = [];
    var authInfo;
    $(document).ready(function () {

        if($.localStorage.get("count") == undefined){
            $.localStorage.set("count", 0);
        }

        VK.init({
            apiId: 4981357
        });

        VK.Auth.getLoginStatus(function (response) {
            if (response.session) {
                GO(response.session);
            } else {
                VK.Auth.getLoginStatus(authInfo);

            }
        });

        authInfo = function(response) {
            if (response.session) {
                GO(response.session);
            } else {
                VK.UI.button('login_button');
            }
        }

        function appendPhoto(photo) {

            el = document.createElement("div");
            salvattore.appendElements(document.querySelector("#items-content"), [el]);
            el.outerHTML = '<a href="' + photo.link + '" class="thumbnail"><img src="' + photo.src + '"></a>';
        }

        function GO(sessions) {


            var s = document.querySelector(".s1");

            VK.Api.call('polls.getVoters', {
                owner_id: '-67272468',
                poll_id: 186926805,
                answer_ids: 617947271,
                count: 1000
            }, function (Voters) {
                if (Voters.response == undefined) {
                    return;
                }
                people = Voters.response[0].users;
                if(parseInt($.localStorage.get("count")) < people.length) {
                    searchNext();
                }
                else{
                    console.log("Cache found, loading...");
                    $.localStorage.get("photos").forEach(function(t){
                        appendPhoto(t);
                    });
                }

            });
            function searchNext() {
                curr_id += 1;
                if (curr_id <= people.length - 1) {
                    VK.Api.call('users.get', {user_ids: people[curr_id], fields:'sex'}, function(r){
                        console.log(r);
                        if(r.response[0].sex == 2)
                            return;
                        VK.Api.call("photos.getAll", {count: 100, extended: 1, owner_id: people[curr_id]}, function (p) {
                            photos = [];
                            console.log(p);
                            if (p.response == undefined) {
                                return;
                            }
                            if (p.response[0] != 0 && p.response.length > 0) {
                                p.response.forEach(function (photo) {
                                    if (typeof photo == "number") return;
                                    if (photo.created < 1388516400)  return;
                                    photos.push(
                                            {
                                                src: photo.src_xbig || photo.src_big || photo.src,
                                                likes: photo.likes.count
                                            })
                                });

                                photos.sort(function (a, b) {
                                    if (a.likes > b.likes)
                                        return -1;
                                    if (a.likes < b.likes)
                                        return 1;
                                    return 0;
                                });

                                href = "https://vk.com/id" + people[curr_id];
                                var photo = {src: photos[0].src, link: href};
                                uPhotos.push(photo);
                                appendPhoto(photo);
                            }

                        });
                    });
                    setTimeout(searchNext, 670);
                }else{
                    $.localStorage.set("photos", JSON.stringify(uPhotos));
                    $.localStorage.set("count", people.length);
                }
            }

        }
    });


</script>
<script src="http://peretz74.ru/assets/js/salvattore.js"></script>
<script src="js/cache.js"></script>
<script src="http://vk.com/js/api/openapi.js" type="text/javascript"></script>
</html>